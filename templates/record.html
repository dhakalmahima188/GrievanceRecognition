<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder</title>
</head>
<body>

    <div style="display:flex;justify-content:center;align-items:center;margin-top: 100px;">
       
    </div>
    {% if audio_path%}
        <div style="display:flex;justify-content:center;align-items:center;margin-top: 10px;">
            <!-- <a href="{{audio_path}}">{{audio_path}}</a> -->
        </div>
    {%endif%}
    <div id="fileform" style="display:flex;justify-content:center;align-items:center;margin-top: 10px;">

        <form action="{%url 'record_audio' %} " 
        method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="audio"><strong>Upload Audio: </strong></label>
            <input type="file" name="audio" accept="audio/*"><br><br>
                       <button type="submit">Submit</button>
                       <a href="{% url 'audio_list' %}">Audio Complain Lists</a>
        </form>
    <div style="display:flex;justify-content:center;align-items:center;margin-top: 100px;">
        <!-- Space for any additional elements or messages -->
    </div>
    <!-- Display this section if there's an audio path available from the server -->
    {% if audio_path %}
    {% csrf_token %}
    <div style="display:flex;justify-content:center;align-items:center;margin-top: 10px;">
        <!-- <a href="{{audio_path}}">{{audio_path}}</a> -->
    </div>
    {% endif %}
    <div id="fileform" style="display:flex;justify-content:center;align-items:center;margin-top: 10px;">
        <!-- Removed the form since we're handling submission via JavaScript now -->
    </div>

    <button onclick="startRecording()">Start Recording</button>
    <button onclick="stopRecording()" disabled>Stop Recording</button>
    <button id="submitAudio" disabled>Submit Audio</button> <!-- Added a button for submitting audio -->
    <audio controls></audio>

    <script>
        function getCSRFToken() {
            let csrfToken = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, "csrftoken=".length) === "csrftoken=") {
                        csrfToken = decodeURIComponent(cookie.substring("csrftoken=".length));
                        break;
                    }
                }
            }
            return csrfToken;
        }
        
        
        let mediaRecorder;
        let audioBlob;
        let audioChunks = [];

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    audioChunks = [];

                    mediaRecorder.addEventListener("dataavailable", event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener("stop", () => {
                        audioBlob = new Blob(audioChunks, {type: 'audio/mp3'});
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = document.querySelector("audio");
                        audio.src = audioUrl;

                        document.getElementById("submitAudio").disabled = false; // Enable the submit button
                    });

                    document.querySelector('button[onclick="startRecording()"]').disabled = true;
                    document.querySelector('button[onclick="stopRecording()"]').disabled = false;
                });
        }

        function stopRecording() {
            mediaRecorder.stop();
            document.querySelector('button[onclick="startRecording()"]').disabled = false;
            document.querySelector('button[onclick="stopRecording()"]').disabled = true;
        }

        document.getElementById("submitAudio").addEventListener("click", function() {
            const formData = new FormData();
            formData.append("audio", audioBlob, "recorded_audio.mp3");

            fetch("{%url 'record_audio' %}", {
                method: "POST",
                body: formData,
                headers: {
                    // Include CSRF token as part of request headers
                    "X-CSRFToken": getCSRFToken(),
                },
                // Add any headers or CSRF tokens if necessary
                
            }).then(response => {
                // Handle response
                console.log("Audio submitted", response);
            }).catch(error => {
                // Handle error
                console.error("Error submitting audio", error);
            });

            this.disabled = true; // Optionally disable the submit button after submission
        });

    </script>
</body>
</html>
